name: Builds

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 10.24.0-release.0). Empty = Auto."
        required: false
      prerelease:
        description: "Use Pre-releases"
        type: boolean
        default: false
        required: false
      includes:
        description: "Manual Includes (comma separated)"
        required: false
      excludes:
        description: "Manual Excludes (comma separated)"
        required: false
  schedule:
    - cron: "0 23 * * *"

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.scrape.outputs.version }}
      piko_tag: ${{ steps.scrape.outputs.piko_tag }}
      int_tag: ${{ steps.scrape.outputs.int_tag }}
      build_tag: ${{ steps.scrape.outputs.build_tag }}
      should_build: ${{ steps.scrape.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Check Version & Tags
        id: scrape
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_VER: ${{ inputs.version }}
          USE_PRE: ${{ inputs.prerelease }}
          UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
        run: |
          BASE="https://www.apkmirror.com"

          if [ -n "$INPUT_VER" ]; then
            VER="$INPUT_VER"
            CLEAN=$(echo "$VER" | tr '.' '-')
            PATH_VER="/apk/x-corp/twitter/x-${CLEAN}-release/"
          else
            PATH_VER=$(curl -s -H "User-Agent: $UA" "$BASE/apk/x-corp/twitter/" | \
              grep -oP 'href="/apk/x-corp/twitter/x-[^"]*-release/"' | head -n1 | sed 's/href="//;s/"//')
            VER=$(echo "$PATH_VER" | sed -E 's/.*x-([0-9.-]+)-release.*/\1/' | tr '-' '.')
            VER=${VER%.}
          fi

          if [ -z "$VER" ]; then
            echo "Error: Could not resolve version."
            exit 1
          fi

          if [ "$USE_PRE" == "true" ]; then
             echo "Fetching latest tags (including pre-releases)..."
             PIKO=$(gh release list --repo crimera/piko --limit 1 --json tagName --jq '.[0].tagName')
             INT=$(gh release list --repo crimera/revanced-integrations --limit 1 --json tagName --jq '.[0].tagName')
          else
             echo "Fetching latest stable releases..."
             PIKO=$(gh release view --repo crimera/piko --json tagName --jq '.tagName')
             INT=$(gh release view --repo crimera/revanced-integrations --json tagName --jq '.tagName')
          fi

          BUILD_TAG="v${VER}-${PIKO}"
          echo "Twitter: $VER | Piko: $PIKO | Int: $INT | Tag: $BUILD_TAG"

          echo "Twitter: $VER | Piko: $PIKO | Tag: $BUILD_TAG"

          if [ -n "$INPUT_VER" ] || ! gh release view "$BUILD_TAG" >/dev/null 2>&1; then
             echo "should_build=true" >> $GITHUB_OUTPUT
          else
             echo "should_build=false" >> $GITHUB_OUTPUT
          fi

          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "piko_tag=$PIKO" >> $GITHUB_OUTPUT
          echo "int_tag=$INT" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "path=$PATH_VER" >> $GITHUB_OUTPUT

      - name: Download & Merge Bundle
        if: steps.scrape.outputs.should_build == 'true'
        env:
          UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
          BASE: "https://www.apkmirror.com"
          PATH_VER: ${{ steps.scrape.outputs.path }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # get variant
          PAGE=$(curl -sL -H "User-Agent: $UA" "$BASE$PATH_VER")
          PATH_VAR=$(echo "$PAGE" | sed 's/<div class="table-row/\n<div class="table-row/g' | \
            grep -oP 'href="/apk/x-corp/twitter/x-[^"]*download/' | \
            head -n1 | sed 's/href="//')

          if [ -z "$PATH_VAR" ]; then echo "Error: Variant not found"; exit 1; fi

          # get download page
          PATH_DL=$(curl -sL -H "User-Agent: $UA" "$BASE$PATH_VAR" | grep -oP 'href="/apk/x-corp/twitter/x-[^"]*key=[^"]*"' | head -n1 | sed 's/href="//;s/"//')

          if [ -z "$PATH_DL" ]; then echo "Error: Download Key page not found"; exit 1; fi

          # get direct link
          DIRECT=$(curl -sL -H "User-Agent: $UA" "$BASE$PATH_DL" | grep -oP 'id="download-link".*?href="\K[^"]+' | sed "s/&amp;/\&/g; s|^/|$BASE/|")
          if [ -z "$DIRECT" ]; then echo "Error: Direct link not found"; exit 1; fi

          echo "Downloading: $DIRECT"
          curl -L -H "User-Agent: $UA" -o twitter_base_apkmirror.apkm "$DIRECT"

          # merge
          gh release download --repo REAndroid/APKEditor -p "*.jar"
          mv APKEditor-*.jar apkeditor.jar
          java -jar apkeditor.jar m -i twitter_base_apkmirror.apkm -o base.apk

      - if: steps.scrape.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: base-apk
          path: base.apk
          retention-days: 1

  build:
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: x-piko
            inc: ""
            exc: "Dynamic color"
          - name: x-piko-material-you
            inc: ""
            exc: ""
          - name: twitter-piko
            inc: "Bring back twitter"
            exc: "Dynamic color"
          - name: twitter-piko-material-you
            inc: "Bring back twitter"
            exc: ""
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - uses: actions/download-artifact@v4
        with:
          name: base-apk

      - name: Patch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VER: ${{ needs.prepare.outputs.version }}
          PIKO_TAG: ${{ needs.prepare.outputs.piko_tag }}
          INT_TAG: ${{ needs.prepare.outputs.int_tag }}
          MATRIX_INC: ${{ matrix.variant.inc }}
          MATRIX_EXC: ${{ matrix.variant.exc }}
          MANUAL_INC: ${{ inputs.includes }}
          MANUAL_EXC: ${{ inputs.excludes }}
        run: |
          gh release download "$PIKO_TAG" --repo crimera/piko -p "*.jar" -p "*.rvp" -D bins

          IFS=',' read -r -a MATRIX_INC_ARR <<< "$MATRIX_INC"
          IFS=',' read -r -a MATRIX_EXC_ARR <<< "$MATRIX_EXC"
          IFS=',' read -r -a MANUAL_INC_ARR <<< "$MANUAL_INC"
          IFS=',' read -r -a MANUAL_EXC_ARR <<< "$MANUAL_EXC"

          PATCH_ARGS=()
          add_patch() {
            local flag=$1
            local name=$(echo "$2" | xargs) # trim whitespace
            if [ -n "$name" ]; then
              PATCH_ARGS+=( "$flag" "$name" )
            fi
          }

          if ls bins/*.rvp 1> /dev/null 2>&1; then
            echo ">> RVP detected"
            mv bins/*.rvp bins/patches.rvp
            gh release download --repo inotia00/revanced-cli -p "revanced-cli*.jar" -D bins
            mv bins/revanced-cli*.jar bins/cli.jar

            BASE_ARGS=( "patch" "-p" "bins/patches.rvp" )
            INC_FLAG="-e"
            EXC_FLAG="-d"
            
          else
            echo ">> JAR detected (legacy)"
            mv bins/*.jar bins/patches.jar
            gh release download v4.6.2 --repo inotia00/revanced-cli -p "revanced-cli*.jar" -D bins
            mv bins/revanced-cli*.jar bins/cli.jar
            gh release download "$INT_TAG" --repo crimera/revanced-integrations -p "revanced*.apk" -D bins
            mv bins/revanced*.apk bins/integrations.apk

            BASE_ARGS=( "patch" "-b" "bins/patches.jar" "-m" "bins/integrations.apk" )
            INC_FLAG="--include"
            EXC_FLAG="--exclude"
            COMMON_PATCHES=(
              "Enable app downgrading"
              "Hide FAB"
              "Disable chirp font"
              "Add ability to copy media link"
              "Hide Banner"
              "Hide promote button"
              "Hide Community Notes"
              "Delete from database"
              "Customize Navigation Bar items"
              "Remove premium upsell"
              "Control video auto scroll"
              "Force enable translate"
            )
            for p in "${COMMON_PATCHES[@]}"; do add_patch "$INC_FLAG" "$p"; done
          fi

          for p in "${MATRIX_INC_ARR[@]}"; do add_patch "$INC_FLAG" "$p"; done
          for p in "${MATRIX_EXC_ARR[@]}"; do add_patch "$EXC_FLAG" "$p"; done
          for p in "${MANUAL_INC_ARR[@]}"; do add_patch "$INC_FLAG" "$p"; done
          for p in "${MANUAL_EXC_ARR[@]}"; do add_patch "$EXC_FLAG" "$p"; done

          echo "Running patcher with ${#PATCH_ARGS[@]} arguments..."
          java -jar bins/cli.jar \
            "${BASE_ARGS[@]}" \
            "${PATCH_ARGS[@]}" \
            --keystore ks.keystore \
            --keystore-entry-password "123456789" \
            --keystore-password "123456789" \
            --signer jhc \
            --keystore-entry-alias jhc \
            --out "${{ matrix.variant.name }}-v${VER}.apk" \
            base.apk

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.variant.name }}
          path: "${{ matrix.variant.name }}-v${{ needs.prepare.outputs.version }}.apk"

  release:
    needs: [prepare, build]
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-piko*"
          merge-multiple: true

      - name: Publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.build_tag }}
          BODY: "Twitter: ${{ needs.prepare.outputs.version }}\nPiko: ${{ needs.prepare.outputs.piko_tag }}"
          USE_PRE: ${{ inputs.prerelease }}
        run: |
          if [ "$USE_PRE" == "true" ]; then
            FLAG="--prerelease"
          else
            FLAG="--latest"
          fi
          gh release create "$TAG" -t "$TAG" -n "$BODY" $FLAG artifacts/*.apk
